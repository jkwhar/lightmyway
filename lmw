#include <FastLED.h>

// LED configuration
#define NUM_LEDS 200
#define DATA_PIN 7
#define LED_TYPE WS2811
#define COLOR_ORDER GRB
#define BRIGHTNESS 180

CRGB leds[NUM_LEDS];

// Radar UART pins
HardwareSerial Radar(1);
#define RADAR_RX 8
#define RADAR_TX 9

// Physical stairs length
const float stairLengthCM = 300.0;   // actual measured stair length

void setup() {
  Serial.begin(115200);

  FastLED.addLeds<LED_TYPE, DATA_PIN, COLOR_ORDER>(leds, NUM_LEDS);
  FastLED.setBrightness(BRIGHTNESS);

  Radar.begin(256000, SERIAL_8N1, RADAR_RX, RADAR_TX);

  Serial.println("LD2450 stair tracking ready.");
}

void loop() {
  int x_cm = readRadarX();       // returns cm from top radar

  if (x_cm >= 0) {
    int ledIndex = map(x_cm, 0, stairLengthCM, NUM_LEDS - 1, 0);
    // note: reversed because 0cm = top, but LED#0 = bottom

    drawBlock(ledIndex);
    FastLED.show();
  }

  delay(20);
}

// ———————————————————————————————————————————————
// Read LD2450 target #1 X position (cm)
// ———————————————————————————————————————————————
int readRadarX() {
  static uint8_t buf[45];
  static int idx = 0;

  while (Radar.available()) {
    uint8_t b = Radar.read();
    buf[idx++] = b;

    if (idx == 45) {
      idx = 0;

      // bytes 9-10 = X position (int16, little endian)
      int16_t x = buf[9] | (buf[10] << 8);

      if (x >= 0 && x <= 600)  // basic sanity filter
        return x;
    }
  }

  return -1;
}

// ———————————————————————————————————————————————
// Draw a 3-pixel (9 LED) warm white block following user
// ———————————————————————————————————————————————
void drawBlock(int centerLED) {
  FastLED.clear();

  int blockSize = 9;     // 3 pixels (3 LEDs each)
  int half = blockSize / 2;

  for (int i = -half; i <= half; i++) {
    int index = centerLED + i;
    if (index >= 0 && index < NUM_LEDS) {
      leds[index] = CRGB(255, 200, 150); // warm white tone
    }
  }
}
